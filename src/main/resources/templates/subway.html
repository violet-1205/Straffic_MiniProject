<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<body>
<div layout:fragment="content">
    <style>
        .subway-container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .search-box { position: relative; margin-bottom: 16px; }
        .search-input { width: 100%; padding: 12px 16px; border: 1px solid #ddd; border-radius: 8px; }
        .autocomplete-list { position:absolute; left:0; right:0; background:#fff; border:1px solid #0066ff; border-top:none; border-radius:0 0 8px 8px; max-height:240px; overflow:auto; display:none; z-index:10; }
        .autocomplete-item { padding:10px 14px; border-bottom:1px solid #f1f1f1; cursor:pointer; }
        .autocomplete-item:last-child { border-bottom:none; }
        .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:16px 0; }
        .stat-card { background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; text-align:center; }
        .arrival-section { background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; display:none; }
        .arrival-section.show { display:block; }
        .train-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
        .train-direction-section { border:1px solid #eee; border-radius:8px; padding:12px; }
    </style>

    <div class="subway-container">
        <h1>ğŸš‡ ì§€í•˜ì²  ì‹¤ì‹œê°„</h1>
        <p>ì—­ ì´ë¦„ì„ ê²€ìƒ‰í•´ ì‹¤ì‹œê°„ ë„ì°© ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>

        <div class="search-box">
            <input id="stationSearch" class="search-input" placeholder="ì˜ˆ: ê°•ë‚¨, ì„œìš¸ì—­, í™ëŒ€ì…êµ¬">
            <div id="autocomplete" class="autocomplete-list"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">ì´ ì—­ ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statArrivals">0</div>
                <div class="stat-label">í‘œì‹œ ì¤‘ì¸ ì—´ì°¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">9</div>
                <div class="stat-label">ë…¸ì„ </div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statUpdated">-</div>
                <div class="stat-label">ì—…ë°ì´íŠ¸</div>
            </div>
        </div>

        <div id="arrivalSection" class="arrival-section">
            <div class="arrival-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px;">
                <div class="arrival-station-name" id="arrivalStationName">-</div>
                <div class="arrival-updated" id="arrivalUpdated">-</div>
            </div>
            <div class="train-grid" id="trainGrid"></div>
        </div>
    </div>

    <script>
        const input = document.getElementById('stationSearch');
        const list = document.getElementById('autocomplete');
        const trainGrid = document.getElementById('trainGrid');
        const section = document.getElementById('arrivalSection');
        const statTotal = document.getElementById('statTotal');
        const statArrivals = document.getElementById('statArrivals');
        const statUpdated = document.getElementById('statUpdated');

        input.addEventListener('input', async () => {
            const keyword = input.value.trim();
            if (!keyword) { list.style.display = 'none'; return; }
            const response = await fetch(`/subway/api/search?keyword=${encodeURIComponent(keyword)}`);
            const items = await response.json();
            list.innerHTML = items.map(it => `<div class="autocomplete-item" data-name="${it.stationName}">${it.stationName} <span style="color:#777; font-size:12px;">(${it.lineName})</span></div>`).join('');
            list.style.display = items.length ? 'block' : 'none';
        });

        list.addEventListener('click', async (e) => {
            const item = e.target.closest('.autocomplete-item');
            if (!item) return;
            const stationName = item.dataset.name;
            list.style.display = 'none';
            input.value = stationName;
            const response = await fetch(`/subway/api/arrival/${encodeURIComponent(stationName.replace(/ì—­$/,''))}`);
            const data = await response.json();
            document.getElementById('arrivalStationName').textContent = stationName;
            const d = new Date();
            statUpdated.textContent = d.toLocaleTimeString();
            section.classList.add('show');
            trainGrid.innerHTML = renderArrivals(data.arrivals || []);
            statArrivals.textContent = (data.arrivals || []).length;
        });

        function renderArrivals(arrivals) {
            if (!arrivals.length) return '<div style="grid-column: 1/-1; color:#777;">ë„ì°© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            return arrivals.map(a => `
                <div class="train-direction-section">
                    <div style="display:flex; justify-content:space-between;">
                        <div><strong>${a.direction}</strong> Â· ${a.trainType}</div>
                        <div>${a.carriages}</div>
                    </div>
                    <div style="margin-top:8px; display:flex; justify-content:space-between;">
                        <div>ëª©ì ì§€: ${a.destination}</div>
                        <div>í˜¼ì¡ë„: ${a.congestion}</div>
                    </div>
                    <div style="margin-top:8px;">ë„ì°©ê¹Œì§€ ì•½ ${a.arrivalTime}ë¶„ Â· ë‚¨ì€ ì—­ ${a.stationsBefore}ê°œ</div>
                    <div style="margin-top:8px; color:#0066ff">${a.status}</div>
                </div>
            `).join('');
        }

        (async () => {
            const r = await fetch('/subway/api/stations/by-line?lineNumber=1');
            const d = await r.json();
            statTotal.textContent = (d.stations || []).length;
        })();
    </script>
</div>
</body>
</html>
